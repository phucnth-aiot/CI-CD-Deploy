name: Build, Push, Pull & Deploy (Self-hosted)

on:
  push:
    branches: [ main ] # hoáº·c branch báº¡n muá»‘n deploy

jobs:
  build_push_pull_run:
    runs-on: self-hosted
    steps:
      - name: âœ… Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Build backend image
        run: docker build -t ngthanhhoangphuc/my-fullstack-backend:latest ./Backend

      - name: ğŸ³ Build frontend image
        run: docker build -t ngthanhhoangphuc/my-fullstack-frontend:latest ./Frontend

      - name: ğŸ”‘ Login to Docker Hub
        shell: pwsh
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

      - name: ğŸ“¤ Push backend image
        run: docker push ngthanhhoangphuc/my-fullstack-backend:latest

      - name: ğŸ“¤ Push frontend image
        run: docker push ngthanhhoangphuc/my-fullstack-frontend:latest

      - name: ğŸ“¥ Pull backend image
        run: docker pull ngthanhhoangphuc/my-fullstack-backend:latest

      - name: ğŸ“¥ Pull frontend image
        run: docker pull ngthanhhoangphuc/my-fullstack-frontend:latest

      - name: ğŸ›‘ Stop and remove old containers
        run: docker-compose down || true

      - name: ğŸš€ Start new containers
        run: docker-compose up -d

      - name: ğŸ§¹ Clean up old images
        run: docker image prune -f
